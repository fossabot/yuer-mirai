<%- include('./layouts/header') %>
  <div class="main">
    <div uk-grid>
      <div class="uk-width-2-3@l limit-height">
        <div class="uk-card uk-card-default uk-card-limit">
          <div class="uk-card-header">
            可爱的月華们
          </div>
          <div class="uk-card-body" id="bot_list">
          </div>
        </div>
      </div>
      <div class="uk-width-1-3@l limit-height">
        <div class="uk-card uk-card-default">
          <div class="uk-card-header">
            申领一个月華
          </div>
          <div class="uk-card-body">
            <form onsubmit="return false">
              <div class="uk-margin">
                <div class="uk-inline-block">
                  <span class="uk-form-icon" uk-icon="icon: user"></span>
                  <input class="uk-input" type="text" id="adopt_user_id" placeholder="月華用QQ号">
                </div>
              </div>
              <div class="uk-margin">
                <div class="uk-inline-block">
                  <span class="uk-form-icon uk-form-icon-flip" uk-icon="icon: lock"></span>
                  <input class="uk-input" type="password" id="adopt_token" placeholder="唯一令牌">
                </div>
              </div>
              <div class="uk-margin">
                <label><input class="uk-checkbox" type="checkbox" id="adopt_use_private" checked> 启用私聊消息回复</label>
              </div>
              <div class="uk-margin">
                <label><input class="uk-checkbox" type="checkbox" id="adopt_use_group" checked> 启用群聊消息回复</label>
              </div>
              <div class="uk-margin">
                <button class="uk-button uk-button-default uk-inline-block" type="button" onclick="adopt()">申领月華</button>
              </div>
              <div class="uk-margin">
                <p>注意：QQ号为您想将月華部署的QQ号，令牌是您日后下载或编辑月華配置所需的唯一凭证。</p>
              </div>
            </form>
          </div>
        </div>
        <div class="uk-card uk-card-default" style="margin-top: 16px">
          <div class="uk-card-header">
            月華配置中心
          </div>
          <div class="uk-card-body">
            <form onsubmit="return false">
              <div class="uk-margin">
                <div class="uk-inline-block">
                  <span class="uk-form-icon" uk-icon="icon: user"></span>
                  <input class="uk-input" type="text" id="config_user_id" placeholder="月華用QQ号">
                </div>
              </div>
              <div class="uk-margin">
                <div class="uk-inline-block">
                  <span class="uk-form-icon uk-form-icon-flip" uk-icon="icon: lock"></span>
                  <input class="uk-input" type="password" id="config_token" placeholder="唯一令牌">
                </div>
              </div>
              <div class="uk-margin">
                <button class="uk-button uk-button-default uk-inline-block" type="button" onclick="download_config()">下载月華用配置文件</button>
              </div>
              <div class="uk-margin">
                <button class="uk-button uk-button-default uk-inline-block" type="button" onclick="edit_config()">编辑月華设置</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div id="modal-edit-config" uk-modal>
      <div class="uk-modal-dialog">
        <button class="uk-modal-close-default" type="button" uk-close></button>
        <div class="uk-modal-header">
          <h2 class="uk-modal-title" style="font-size: 18px; margin: 10px 0;">在这里编辑您的月華配置</h2>
        </div>
        <div class="uk-modal-body" uk-overflow-auto>
          <form>
            <fieldset class="uk-fieldset">
              <div class="uk-margin">
                <label class="uk-form-label" for="edit_group_white_list">群白名单</label>
                <div class="uk-form-controls">
                  <input class="uk-input" id="edit_group_white_list" type="text" placeholder="群白名单">
                </div>
              </div>
              <div class="uk-margin">
                <label class="uk-form-label" for="edit_group_black_list">群黑名单</label>
                <div class="uk-form-controls">
                  <input class="uk-input" id="edit_group_black_list" type="text" placeholder="群黑名单">
                </div>
              </div>
              <div class="uk-margin uk-grid-small uk-child-width-auto uk-grid">
                <label><input class="uk-checkbox" type="checkbox" id="edit_use_private"> 启用私聊消息回复</label>
                <label style="margin-left: 24px;"><input class="uk-checkbox" type="checkbox" id="edit_use_group"> 启用群聊消息回复</label>
              </div>
              <div class="uk-margin">
                <p>如果禁用群消息回复，月華将不会对任何QQ群进行响应。如果把指定QQ群加入群黑名单，即使该群亦在群白名单，月華也不会对该QQ群进行响应。请始终保持群白名单为 ['*']，除非您只想对部分群进行响应。</p>
              </div>
              <div class="uk-margin">
                <p>白名单或黑名单示例：10000, 12345, 23333。用半角逗号分隔。</p>
              </div>
              <hr class="uk-divider-icon">
              <div class="uk-margin">
                <p>以下为高级设置：（仅限獭獭HTTP POST）</p>
              </div>
              <div class="uk-margin uk-grid-small uk-child-width-auto uk-grid">
                <label><input class="uk-checkbox" type="checkbox" id="edit_use_tata"> 启用獭獭转接</label>
              </div>
              <div class="uk-margin">
                <label class="uk-form-label" for="edit_tata_url">獭獭POST地址</label>
                <div class="uk-form-controls">
                  <input class="uk-input" id="edit_tata_url" type="text" placeholder="獭獭POST地址">
                </div>
              </div>
              <div class="uk-margin">
                <label class="uk-form-label" for="edit_tata_access">獭獭令牌</label>
                <div class="uk-form-controls">
                  <input class="uk-input" id="edit_tata_access" type="text" placeholder="獭獭令牌">
                </div>
              </div>
            </fieldset>
          </form>
        </div>
        <div class="uk-modal-footer uk-text-right">
          <button class="uk-button uk-button-primary" type="button" onclick="submit_edit_config()">提交修改</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    let bot_list_table
    $(document).ready(() => {
      $.ajax({
        url: '/adopt_list',
        type: 'post',
        success: (data) => {
          trigger_bot_list_update(JSON.parse(data))
        },
        error: (err) => {
          UIkit.modal.alert('网络通讯错误，请检查您的网络设置。详情：' + err)
        }
      })
    })
    function adopt () {
      let user_id = parseInt($('#adopt_user_id').val())
      let token = $('#adopt_token').val()
      let use_private = $('#adopt_use_private').prop('checked')
      let use_group = $('#adopt_use_group').prop('checked')
      if (isNaN(user_id) || user_id < 10000 || user_id > 9999999999) {
        UIkit.modal.alert('您输入的月華用QQ号有误，请确定在[10000, 9999999999]范围内。')
      } else if (token.length < 6 || token.length > 32) {
        UIkit.modal.alert('您输入的令牌长度有误，请确定长度在[6, 32]范围内。')
      } else {
        UIkit.modal.confirm('您的月華用QQ号为：【' + user_id + '】，令牌为：【' + token + '】。【' +
          (use_private ? '启用' : '禁用') + '】私聊消息回复，【' + (use_group ? '启用' : '禁用') + '】群聊消息回复。' +
          '令牌为您下载或修改月華配置时必备的凭证，无法修改请牢记！').then(() => {
          $.ajax({
            url: '/adopt',
            type: 'post',
            dataType: 'json',
            data: {
              user_id, token, use_private, use_group
            },
            success: (data) => {
              if (data.code === 0) {
                UIkit.modal.alert('申领成功，您的月儿已被创建，请前去下载配置文件。')
              } else {
                UIkit.modal.alert('申领失败，原因：' + data.msg + '。错误代码：' + data.code)
              }
            },
            error: (err) => {
              UIkit.modal.alert('网络通讯错误，请检查您的网络设置。详情：' + err)
            }
          })
        }, () => { console.log('cancelled') })
      }
    }
    function download_config () {
      let user_id = parseInt($('#config_user_id').val())
      let token = $('#config_token').val()
      if (isNaN(user_id) || user_id < 10000 || user_id > 9999999999) {
        UIkit.modal.alert('您输入的月華用QQ号有误，请确定在[10000, 9999999999]范围内。')
      } else if (token.length < 6 || token.length > 32) {
        UIkit.modal.alert('您输入的令牌长度有误，请确定长度在[6, 32]范围内。')
      } else {
        $.ajax({
          url: '/download_config',
          type: 'post',
          dataType: 'json',
          data: {
            user_id, token
          },
          success: (data) => {
            if (data.code === 0) {
              let blob = new Blob([data.config], {
                type: 'text/plain;charset=utf-8'
              })
              let dl = $('<a>')
              dl.html('<span id="span' + user_id + '"></span>')
              dl.attr('href', window.URL.createObjectURL(blob))
              dl.attr('download', 'setting.yml')
              dl.attr('style', 'display: none')
              $('body').append(dl)
              $('#span' + user_id).click()
              UIkit.modal.alert('<p>配置文件已经开始下载，若无法下载，请尝试使用Chrome浏览器。</p>')
            } else {
              UIkit.modal.alert('下载失败，原因：' + data.msg + '。错误代码：' + data.code)
            }
          },
          error: (err) => {
            UIkit.modal.alert('网络通讯错误，请检查您的网络设置。详情：' + err)
          }
        })
      }
    }
    function edit_config () {
      fetch_config()
    }
    function trigger_bot_list_update (data) {
      bot_list_table = $('<table>').attr('class', 'uk-table uk-table-striped uk-table-small bot-list-table')
      // let thead = $('<thead>').html('<tr><th>月華用QQ号</th><th>月華昵称</th><th>私聊回复</th><th>群聊回复</th><th>客户端版本</th><th>在线状态</th></tr>')
      let thead = $('<thead>').html('<tr><th>月華用QQ号</th><th>月華昵称</th><th>私聊回复</th><th>群聊回复</th><th>在线状态</th></tr>')
      let tbody = $('<tbody>')
      let tr = []
      for (let i = 0; i < data.count; i++) {
        let td = []
        td.push($('<td>').html(data.bots[i].user_id))
        td.push($('<td>').html(data.bots[i].nickname || '-'))
        td.push($('<td>').html(data.bots[i].use_private ?
          '<span class="uk-label uk-label-success">启用</span>' : '<span class="uk-label uk-label-danger">禁用</span>'))
        td.push($('<td>').html(data.bots[i].use_group ?
          '<span class="uk-label uk-label-success">启用</span>' : '<span class="uk-label uk-label-danger">禁用</span>'))
        // td.push($('<td>').html('<span class="uk-label uk-label-default">' + (data.bots[i].version || '未知') + '</span>'))
        td.push($('<td>').html((data.bots[i].online > new Date().getTime() - 299999) ?
          '<span class="uk-label uk-label-success">在线</span>' : '<span class="uk-label uk-label-danger">离线</span>'))
        tr.push($('<tr>').append(td))
      }
      tbody.append(tr)
      bot_list_table.append(thead, tbody)
      $('#bot_list').html('').append(bot_list_table)
    }
    function fetch_config () {
      let user_id = parseInt($('#config_user_id').val())
      let token = $('#config_token').val()
      if (isNaN(user_id) || user_id < 10000 || user_id > 9999999999) {
        UIkit.modal.alert('您输入的月華用QQ号有误，请确定在[10000, 9999999999]范围内。')
      } else if (token.length < 6 || token.length > 32) {
        UIkit.modal.alert('您输入的令牌长度有误，请确定长度在[6, 32]范围内。')
      } else {
        $.ajax({
          url: '/fetch_config',
          type: 'post',
          dataType: 'json',
          data: {
            user_id, token
          },
          success: (data) => {
            if (data.code === 0) {
              if (data.config.use_private === true) {
                $('#edit_use_private').attr('checked', true)
              }
              if (data.config.use_group === true) {
                $('#edit_use_group').attr('checked', true)
              }
              if (data.config.use_tata === true) {
                $('#edit_use_tata').attr('checked', true)
              }
              $('#edit_group_white_list').val(data.config.allow_groups.join(', '))
              $('#edit_group_black_list').val(data.config.ban_groups.join(', '))
              if (data.config.tata_url) {
                $('#edit_tata_url').val(data.config.tata_url)
              }
              if (data.config.tata_access) {
                $('#edit_tata_access').val(data.config.tata_access)
              }
              UIkit.modal($('#modal-edit-config')).show()
            } else {
              UIkit.modal.alert('获取失败，原因：' + data.msg + '。错误代码：' + data.code)
            }
          },
          error: (err) => {
            UIkit.modal.alert('网络通讯错误，请检查您的网络设置。详情：' + err)
          }
        })
      }
    }
    function submit_edit_config () {
      let user_id = parseInt($('#config_user_id').val())
      let token = $('#config_token').val()
      let use_private = $('#edit_use_private').prop('checked')
      let use_group = $('#edit_use_group').prop('checked')
      let allow_groups = $('#edit_group_white_list').val()
      let ban_groups = $('#edit_group_black_list').val()
      let use_tata = $('#edit_use_tata').prop('checked')
      let tata_url = $('#edit_tata_url').val()
      let tata_access = $('#edit_tata_access').val()
      console.log(allow_groups)
      $.ajax({
          url: '/edit_config',
          type: 'post',
          dataType: 'json',
          data: {
            user_id, token,
            use_private, use_group,
            allow_groups, ban_groups,
            use_tata, tata_url, tata_access
          },
          success: (data) => {
            if (data.code === 0) {
              UIkit.modal.alert('您的月華属性已被修改！')
            } else {
              UIkit.modal.alert('获取失败，原因：' + data.msg + '。错误代码：' + data.code)
            }
          },
          error: (err) => {
            UIkit.modal.alert('网络通讯错误，请检查您的网络设置。详情：' + err)
          }
        })
      console.log($('#edit_group_white_list').val().replace(/ /g, '').split(','))
    }
  </script>
<%- include('./layouts/footer') %>